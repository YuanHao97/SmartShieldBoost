<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETH Trading Simulator - Real-time Price Monitoring</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .price-card {
            text-align: center;
        }

        .current-price {
            font-size: 3rem;
            font-weight: bold;
            color: #4CAF50;
            margin: 20px 0;
        }

        .price-change {
            font-size: 1.2rem;
            margin: 10px 0;
        }

        .positive {
            color: #4CAF50;
        }

        .negative {
            color: #f44336;
        }

        .pool-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .info-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .info-label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
        }

        .trading-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .trading-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-group input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-buy {
            background: #4CAF50;
            color: white;
        }

        .btn-buy:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-sell {
            background: #f44336;
            color: white;
        }

        .btn-sell:hover {
            background: #da190b;
            transform: translateY(-2px);
        }

        .btn-simulate {
            background: #2196F3;
            color: white;
            width: 100%;
            margin-top: 10px;
        }

        .btn-simulate:hover {
            background: #1976D2;
        }

        .trades-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .trades-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .trades-header h3 {
            color: #333;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .refresh-btn:hover {
            background: #5a6fd8;
        }

        .trades-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .trade-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s ease;
        }

        .trade-item:hover {
            background-color: #f8f9fa;
        }

        .trade-item:last-child {
            border-bottom: none;
        }

        .trade-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .trade-type.buy {
            background: #e8f5e8;
            color: #4CAF50;
        }

        .trade-type.sell {
            background: #ffeaea;
            color: #f44336;
        }

        .trade-details {
            flex: 1;
            margin: 0 15px;
        }

        .trade-amount {
            font-weight: bold;
            color: #333;
        }

        .trade-price {
            color: #666;
            font-size: 0.9rem;
        }

        .trade-time {
            color: #999;
            font-size: 0.8rem;
        }


        .status {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 20px 0;
        }

        .status.connected {
            background: #e8f5e8;
            color: #4CAF50;
        }

        .status.disconnected {
            background: #ffeaea;
            color: #f44336;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .trading-form {
                grid-template-columns: 1fr;
            }
            
            .pool-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ ETH Trading Simulator</h1>
            <p>Real-time monitoring of ETH price fluctuations and trading activity</p>
        </div>

        <div class="status" id="status">
            <div>üîå Connecting to blockchain network...</div>
        </div>
        
        <div class="status" id="updateStatus" style="display: none;">
            <div>‚è∞ Next update: <span id="countdown">3</span> seconds</div>
        </div>

        <div class="dashboard">
            <div class="card price-card">
                <h3>üí∞ Current ETH Price</h3>
                <div class="current-price" id="currentPrice">100.00 PYUSD</div>
                <div class="price-change" id="priceChange">
                    <span id="priceChangeText">+0.00%</span>
                </div>
            </div>

            <div class="card">
                <h3>üè¶ Liquidity Pool Information</h3>
                <div class="pool-info">
                    <div class="info-item">
                        <div class="info-label">ETH Reserve</div>
                        <div class="info-value" id="ethReserve">100.00 ETH</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">PYUSD Reserve</div>
                        <div class="info-value" id="pyusdReserve">10,000.00 PYUSD</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Total Liquidity</div>
                        <div class="info-value" id="totalLiquidity">20,000.00</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Trade Count</div>
                        <div class="info-value" id="tradeCount">0</div>
                    </div>
                </div>
            </div>
        </div>


        <div class="trading-section">
            <h3>üíº Trading Operations</h3>
            <div class="trading-form">
                <div class="form-group">
                    <label for="ethAmount">ETH Amount</label>
                    <input type="number" id="ethAmount" placeholder="Enter ETH amount" step="0.01" min="0.01">
                </div>
                <div class="form-group">
                    <label for="pyusdAmount">PYUSD Amount</label>
                    <input type="number" id="pyusdAmount" placeholder="Auto calculated" readonly>
                </div>
            </div>
            <div style="text-align: center;">
                <button class="btn btn-buy" onclick="buyETH()">üü¢ Buy ETH</button>
                <button class="btn btn-sell" onclick="sellETH()">üî¥ Sell ETH</button>
            </div>
            <div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                <h4 style="margin-bottom: 10px; color: #333;">üí° Usage Instructions</h4>
                <ul style="text-align: left; color: #666; font-size: 0.9rem;">
                    <li>Make sure MetaMask wallet is connected</li>
                    <li>Buying ETH requires sufficient PYUSD balance</li>
                    <li>Selling ETH requires sufficient ETH balance</li>
                    <li>Price adjusts automatically based on liquidity pool</li>
                </ul>
            </div>
        </div>

        <div class="trades-section">
            <div class="trades-header">
                <h3>üìã Latest Trading Records</h3>
                <button class="refresh-btn" onclick="refreshTrades()">üîÑ Refresh</button>
            </div>
            <div class="trades-list" id="tradesList">
                <div style="text-align: center; color: #666; padding: 20px;">
                    No trading records available
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="./contract-abis.js"></script>
    <script>
        // Use auto-generated contract ABIs and addresses
        // These values come from contract-abis.js file
        const CONTRACT_ADDRESSES = window.CONTRACT_ADDRESSES || {
            MockPYUSD: "0x5fbdb2315678afecb367f032d93f642f64180aa3",
            MockETH: "0xe7f1725e7734ce288f8367e1bb143e90bb3f0512",
            PyusdHandler: "0x9fe46736679d2d9a65f0992f2272de9f3c7fa6e0",
            LiquidityPool: "0xcf7ed3acca5a467e9e704c703e8d87f634fb0fc9",
            ETHSimulator: "0xdc64a140aa3e981100a9beca4e685f962f0cf6c9"
        };

        // Use full ABIs or simplified ABIs
        const LIQUIDITY_POOL_ABI = window.SIMPLIFIED_ABIS?.LiquidityPool || [
            "function getPoolInfo() external view returns (uint256, uint256, uint256, uint256)",
            "function getCurrentPrice() public view returns (uint256)",
            "function calculateBuyAmount(uint256 _ethAmount) public view returns (uint256)",
            "function calculateSellAmount(uint256 _ethAmount) public view returns (uint256)",
            "event TradeExecuted(address indexed trader, bool isBuy, uint256 ethAmount, uint256 pyusdAmount, uint256 newPrice, uint256 timestamp)"
        ];

        const ETH_SIMULATOR_ABI = window.SIMPLIFIED_ABIS?.ETHSimulator || [
            "function buyETH(uint256 ethAmount) external",
            "function sellETH(uint256 ethAmount) external",
            "function getETHBalance(address user) external view returns (uint256)",
            "function getCurrentPrice() external view returns (uint256)",
            "function getPoolInfo() external view returns (uint256, uint256, uint256, uint256)",
            "event ETHTraded(address indexed trader, bool isBuy, uint256 ethAmount, uint256 pyusdAmount, uint256 newPrice)"
        ];

        const MOCK_PYUSD_ABI = window.SIMPLIFIED_ABIS?.MockPYUSD || [
            "function balanceOf(address account) external view returns (uint256)",
            "function approve(address spender, uint256 amount) external returns (bool)",
            "function transfer(address to, uint256 amount) external returns (bool)"
        ];

        // Global variables
        let provider = null;
        let signer = null;
        let liquidityPoolContract = null;
        let ethSimulatorContract = null;
        let mockPYUSDContract = null;
        let currentPrice = 100;
        let initialPrice = 100;
        let tradeHistory = [];
        let simulationInterval = null;
        let countdownInterval = null;
        let countdown = 3;
        let userAddress = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeWeb3();
            await loadInitialData();
            startPriceUpdates();
            startCountdown();
        });

        // Initialize Web3 connection
        async function initializeWeb3() {
            try {
                // Check if MetaMask is available
                if (typeof window.ethereum !== 'undefined') {
                    // Check if ethers is available
                    if (typeof ethers === 'undefined') {
                        throw new Error('ethers library not loaded correctly, please check network connection');
                    }
                    
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    await provider.send("eth_requestAccounts", []);
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();
                    
                    // Initialize contract instances
                    liquidityPoolContract = new ethers.Contract(CONTRACT_ADDRESSES.LiquidityPool, LIQUIDITY_POOL_ABI, signer);
                    ethSimulatorContract = new ethers.Contract(CONTRACT_ADDRESSES.ETHSimulator, ETH_SIMULATOR_ABI, signer);
                    mockPYUSDContract = new ethers.Contract(CONTRACT_ADDRESSES.MockPYUSD, MOCK_PYUSD_ABI, signer);
                    
                    updateStatus('connected', `‚úÖ Connected to blockchain network (${userAddress.slice(0,6)}...${userAddress.slice(-4)})`);
                    
                    // Listen to trading events
                    setupEventListeners();
                } else {
                    updateStatus('disconnected', '‚ùå Please install MetaMask wallet');
                }
            } catch (error) {
                console.error('Web3 initialization failed:', error);
                updateStatus('disconnected', '‚ùå Failed to connect to blockchain');
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            if (ethSimulatorContract) {
                ethSimulatorContract.on("ETHTraded", (trader, isBuy, ethAmount, pyusdAmount, newPrice, event) => {
                    if (trader.toLowerCase() === userAddress.toLowerCase()) {
                        addTradeToHistory(isBuy, ethAmount, pyusdAmount, newPrice);
                        updatePriceDisplay();
                        updatePoolInfo();
                        updateTradesList();
                    }
                });
            }
        }

        // Load initial data
        async function loadInitialData() {
            try {
                await updatePoolInfo();
                await updatePriceDisplay();
                await loadTradeHistory();
            } catch (error) {
                console.error('Failed to load initial data:', error);
            }
        }


        // Update status
        function updateStatus(type, message) {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${type}`;
            statusEl.innerHTML = `<div>${message}</div>`;
        }

        // Update price display
        async function updatePriceDisplay() {
            try {
                if (ethSimulatorContract) {
                    const priceWei = await ethSimulatorContract.getCurrentPrice();
                    currentPrice = parseFloat(ethers.utils.formatEther(priceWei));
                    
                    if (initialPrice === 100) {
                        initialPrice = currentPrice;
                    }
                }
                
                document.getElementById('currentPrice').textContent = `${currentPrice.toFixed(2)} PYUSD`;
                
                const change = ((currentPrice - initialPrice) / initialPrice * 100).toFixed(2);
                const changeEl = document.getElementById('priceChangeText');
                changeEl.textContent = `${change >= 0 ? '+' : ''}${change}%`;
                changeEl.className = change >= 0 ? 'positive' : 'negative';
            } catch (error) {
                console.error('Failed to update price:', error);
            }
        }

        // Update pool information
        async function updatePoolInfo() {
            try {
                if (ethSimulatorContract) {
                    const poolInfo = await ethSimulatorContract.getPoolInfo();
                    const ethReserve = parseFloat(ethers.utils.formatEther(poolInfo[0]));
                    const pyusdReserve = parseFloat(ethers.utils.formatUnits(poolInfo[1], 6)); // PYUSDÊúâ6‰ΩçÂ∞èÊï∞
                    const totalLiquidity = ethReserve + pyusdReserve / currentPrice;
                    
                    document.getElementById('ethReserve').textContent = `${ethReserve.toFixed(2)} ETH`;
                    document.getElementById('pyusdReserve').textContent = `${pyusdReserve.toLocaleString()} PYUSD`;
                    document.getElementById('totalLiquidity').textContent = `${totalLiquidity.toFixed(2)}`;
                    document.getElementById('tradeCount').textContent = tradeHistory.length;
                }
            } catch (error) {
                console.error('Failed to update pool info:', error);
            }
        }

        // ÂºÄÂßã‰ª∑Ê†ºÊõ¥Êñ∞
        function startPriceUpdates() {
            setInterval(async () => {
                await updatePriceDisplay();
                await updatePoolInfo();
                await loadTradeHistory(); // ÊØèÊ¨°Êõ¥Êñ∞Êó∂ÈáçÊñ∞Âä†ËΩΩ‰∫§ÊòìËÆ∞ÂΩï
                startCountdown();
            }, 3000); // 3ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°
        }

        // ÂºÄÂßãÂÄíËÆ°Êó∂
        function startCountdown() {
            countdown = 3;
            document.getElementById('updateStatus').style.display = 'block';
            
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            countdownInterval = setInterval(() => {
                countdown--;
                document.getElementById('countdown').textContent = countdown;
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('updateStatus').style.display = 'none';
                }
            }, 1000);
        }


        // ‰π∞ÂÖ•ETH
        async function buyETH() {
            const ethAmount = parseFloat(document.getElementById('ethAmount').value);
            if (!ethAmount || ethAmount <= 0) {
                alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑETHÊï∞Èáè');
                return;
            }
            
            try {
                updateStatus('connected', '‚è≥ Ê≠£Âú®Â§ÑÁêÜ‰π∞ÂÖ•‰∫§Êòì...');
                
                // ËÆ°ÁÆóÈúÄË¶ÅÁöÑPYUSDÊï∞Èáè
                const ethAmountWei = ethers.utils.parseEther(ethAmount.toString());
                const pyusdNeededWei = await liquidityPoolContract.calculateBuyAmount(ethAmountWei);
                const pyusdNeeded = parseFloat(ethers.utils.formatUnits(pyusdNeededWei, 6));
                
                // Ê£ÄÊü•Áî®Êà∑PYUSD‰ΩôÈ¢ù
                const userBalance = await mockPYUSDContract.balanceOf(userAddress);
                if (userBalance.lt(pyusdNeededWei)) {
                    alert(`PYUSD‰ΩôÈ¢ù‰∏çË∂≥ÔºåÈúÄË¶Å ${pyusdNeeded.toFixed(2)} PYUSD`);
                    return;
                }
                
                // ÊéàÊùÉPYUSDËΩ¨Ë¥¶
                const approveTx = await mockPYUSDContract.approve(CONTRACT_ADDRESSES.ETHSimulator, pyusdNeededWei);
                await approveTx.wait();
                
                // ÊâßË°å‰π∞ÂÖ•‰∫§Êòì
                const buyTx = await ethSimulatorContract.buyETH(ethAmountWei);
                await buyTx.wait();
                
                updateStatus('connected', '‚úÖ ‰π∞ÂÖ•‰∫§ÊòìÊàêÂäüÔºÅ');
                
                // Êõ¥Êñ∞ÊòæÁ§∫
                await updatePriceDisplay();
                await updatePoolInfo();
                updateTradesList();
                
            } catch (error) {
                console.error('‰π∞ÂÖ•ETHÂ§±Ë¥•:', error);
                updateStatus('disconnected', '‚ùå ‰π∞ÂÖ•‰∫§ÊòìÂ§±Ë¥•');
                alert('‰∫§ÊòìÂ§±Ë¥•: ' + error.message);
            }
        }

        // ÂçñÂá∫ETH
        async function sellETH() {
            const ethAmount = parseFloat(document.getElementById('ethAmount').value);
            if (!ethAmount || ethAmount <= 0) {
                alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑETHÊï∞Èáè');
                return;
            }
            
            try {
                updateStatus('connected', '‚è≥ Ê≠£Âú®Â§ÑÁêÜÂçñÂá∫‰∫§Êòì...');
                
                // Ê£ÄÊü•Áî®Êà∑ETH‰ΩôÈ¢ù
                const ethAmountWei = ethers.utils.parseEther(ethAmount.toString());
                const userETHBalance = await ethSimulatorContract.getETHBalance(userAddress);
                if (userETHBalance.lt(ethAmountWei)) {
                    alert(`ETH‰ΩôÈ¢ù‰∏çË∂≥ÔºåÂΩìÂâç‰ΩôÈ¢ù: ${ethers.utils.formatEther(userETHBalance)} ETH`);
                    return;
                }
                
                // ÊâßË°åÂçñÂá∫‰∫§Êòì
                const sellTx = await ethSimulatorContract.sellETH(ethAmountWei);
                await sellTx.wait();
                
                updateStatus('connected', '‚úÖ ÂçñÂá∫‰∫§ÊòìÊàêÂäüÔºÅ');
                
                // Êõ¥Êñ∞ÊòæÁ§∫
                await updatePriceDisplay();
                await updatePoolInfo();
                updateTradesList();
                
            } catch (error) {
                console.error('ÂçñÂá∫ETHÂ§±Ë¥•:', error);
                updateStatus('disconnected', '‚ùå ÂçñÂá∫‰∫§ÊòìÂ§±Ë¥•');
                alert('‰∫§ÊòìÂ§±Ë¥•: ' + error.message);
            }
        }

        // Ê∑ªÂä†‰∫§ÊòìËÆ∞ÂΩïÂà∞ÂéÜÂè≤
        function addTradeToHistory(isBuy, ethAmount, pyusdAmount, price) {
            const trade = {
                id: Date.now(),
                isBuy: isBuy,
                ethAmount: parseFloat(ethers.utils.formatEther(ethAmount)),
                pyusdAmount: parseFloat(ethers.utils.formatUnits(pyusdAmount, 6)),
                price: parseFloat(ethers.utils.formatEther(price)),
                timestamp: new Date()
            };
            
            tradeHistory.unshift(trade);
            
            // ‰øùÊåÅÊúÄËøë50Á¨î‰∫§Êòì
            if (tradeHistory.length > 50) {
                tradeHistory.pop();
            }
        }

        // Êõ¥Êñ∞‰∫§ÊòìÂàóË°®
        function updateTradesList() {
            const tradesList = document.getElementById('tradesList');
            
            if (tradeHistory.length === 0) {
                tradesList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">ÊöÇÊó†‰∫§ÊòìËÆ∞ÂΩï</div>';
                return;
            }
            
            tradesList.innerHTML = tradeHistory.slice(0, 20).map(trade => `
                <div class="trade-item">
                    <div class="trade-type ${trade.isBuy ? 'buy' : 'sell'}">
                        ${trade.isBuy ? '‰π∞ÂÖ•' : 'ÂçñÂá∫'}
                    </div>
                    <div class="trade-details">
                        <div class="trade-amount">${trade.ethAmount.toFixed(4)} ETH</div>
                        <div class="trade-price">${trade.pyusdAmount.toFixed(2)} PYUSD</div>
                        <div class="trade-trader" style="font-size: 0.7rem; color: #999; margin-top: 2px;">
                            ${trade.trader ? `${trade.trader.slice(0,6)}...${trade.trader.slice(-4)}` : ''}
                        </div>
                    </div>
                    <div class="trade-time">${trade.timestamp.toLocaleTimeString()}</div>
                </div>
            `).join('');
        }

        // Âä†ËΩΩ‰∫§ÊòìÂéÜÂè≤
        async function loadTradeHistory() {
            try {
                const response = await fetch('../trade-history.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Â∞ÜJSONÊï∞ÊçÆËΩ¨Êç¢‰∏∫‰∫§ÊòìËÆ∞ÂΩïÊ†ºÂºè
                tradeHistory = data.trades.map(trade => ({
                    id: trade.id,
                    isBuy: trade.isBuy,
                    ethAmount: trade.ethAmount,
                    pyusdAmount: trade.pyusdAmount,
                    price: trade.price,
                    timestamp: new Date(trade.timestamp),
                    trader: trade.trader
                }));
                
                console.log(`‚úÖ ÊàêÂäüÂä†ËΩΩ ${tradeHistory.length} Êù°‰∫§ÊòìËÆ∞ÂΩï`);
                updateTradesList();
                
            } catch (error) {
                console.error('‚ùå Âä†ËΩΩ‰∫§ÊòìÂéÜÂè≤Â§±Ë¥•:', error);
                // Â¶ÇÊûúÂä†ËΩΩÂ§±Ë¥•Ôºå‰øùÊåÅÁ©∫ÁöÑ‰∫§ÊòìÂéÜÂè≤
                tradeHistory = [];
                updateTradesList();
            }
        }

        // Âà∑Êñ∞‰∫§ÊòìËÆ∞ÂΩï
        async function refreshTrades() {
            console.log('üîÑ Ê≠£Âú®Âà∑Êñ∞‰∫§ÊòìËÆ∞ÂΩï...');
            await loadTradeHistory();
        }

        // ETHÊï∞ÈáèËæìÂÖ•ÂèòÂåñÊó∂Êõ¥Êñ∞PYUSDÊï∞Èáè
        document.getElementById('ethAmount').addEventListener('input', async function() {
            const ethAmount = parseFloat(this.value);
            if (ethAmount > 0 && liquidityPoolContract) {
                try {
                    const ethAmountWei = ethers.utils.parseEther(ethAmount.toString());
                    const pyusdNeededWei = await liquidityPoolContract.calculateBuyAmount(ethAmountWei);
                    const pyusdAmount = parseFloat(ethers.utils.formatUnits(pyusdNeededWei, 6));
                    document.getElementById('pyusdAmount').value = pyusdAmount.toFixed(2);
                } catch (error) {
                    console.error('ËÆ°ÁÆóPYUSDÊï∞ÈáèÂ§±Ë¥•:', error);
                    document.getElementById('pyusdAmount').value = 'ËÆ°ÁÆóÂ§±Ë¥•';
                }
            } else {
                document.getElementById('pyusdAmount').value = '';
            }
        });
    </script>
</body>
</html>
